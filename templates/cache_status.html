{% extends "base.html" %}

{% block title %}Cache Status - Crypto Bullrun Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-database"></i> Cache Status & Management</h1>
            <div>
                <button class="btn btn-outline-danger" onclick="clearCache()" 
                        title="Clear all cached data">
                    <i class="fas fa-trash"></i> Clear Cache
                </button>
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <p class="text-muted">Monitor cache performance and manage stored analysis data</p>
    </div>
</div>

<!-- Cache Statistics -->
{% if cache_info %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3 class="text-info">{{ cache_info.file_count.total or 0 }}</h3>
                <p>Total Files</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3 class="text-success">{{ "%.1f"|format(cache_info.cache_size_mb or 0) }} MB</h3>
                <p>Cache Size</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ "%.1f"|format(cache_info.hit_rate or 0) }}%</h3>
                <p>Hit Rate</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ cache_info.saved_api_calls or 0 }}</h3>
                <p>API Calls Saved</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cache Directories -->
{% if cache_info and cache_info.directories %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-folder"></i> Cache Directories</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Path</th>
                                <th>Status</th>
                                <th>Files</th>
                                <th>Size (MB)</th>
                                <th>Primary</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dir in cache_info.directories %}
                            <tr>
                                <td>
                                    <code>{{ dir.path }}</code>
                                    {% if dir.error %}
                                    <br><small class="text-danger">{{ dir.error }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if dir.exists %}
                                    <span class="badge bg-success">Available</span>
                                    {% else %}
                                    <span class="badge bg-danger">Missing</span>
                                    {% endif %}
                                </td>
                                <td>{{ dir.files or 0 }}</td>
                                <td>{{ "%.1f"|format(dir.size_mb or 0) }}</td>
                                <td>
                                    {% if loop.index == 1 %}
                                    <i class="fas fa-star text-warning" title="Primary cache directory"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Top 200 Analysis Files -->
{% if top200_files %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-trophy"></i> Top 200 Analysis Files ({{ top200_files|length }})</h5>
                <small class="text-muted">Most recent files shown</small>
            </div>
            <div class="card-body">
                {% if top200_files|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Modified</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in top200_files %}
                            <tr>
                                <td>
                                    <strong>{{ file.name }}</strong>
                                    <br><small class="text-muted">{{ file.path }}</small>
                                </td>
                                <td>
                                    {{ file.modified.strftime('%Y-%m-%d %H:%M') }}
                                    <br><small class="text-muted">{{ file.modified.strftime('%A') }}</small>
                                </td>
                                <td>{{ "%.1f"|format(file.size/1024) }} KB</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/load-analysis?file={{ file.path }}" 
                                           class="btn btn-outline-primary" title="Load this analysis">
                                            <i class="fas fa-upload"></i>
                                        </a>
                                        <button class="btn btn-outline-info" 
                                                onclick="previewFile('{{ file.path }}')" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteFile('{{ file.path }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No Top 200 analysis files found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Standard Analysis Files -->
{% if standard_files %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chart-line"></i> Standard Analysis Files ({{ standard_files|length }})</h5>
                <small class="text-muted">Watchlist and other analysis results</small>
            </div>
            <div class="card-body">
                {% if standard_files|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Type</th>
                                <th>Modified</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in standard_files %}
                            <tr>
                                <td>
                                    <strong>{{ file.name }}</strong>
                                    <br><small class="text-muted">{{ file.path }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ file.type }}</span>
                                </td>
                                <td>{{ file.modified.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ "%.1f"|format(file.size/1024) }} KB</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/load-analysis?file={{ file.path }}" 
                                           class="btn btn-outline-primary" title="Load this analysis">
                                            <i class="fas fa-upload"></i>
                                        </a>
                                        <button class="btn btn-outline-info" 
                                                onclick="previewFile('{{ file.path }}')" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteFile('{{ file.path }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No standard analysis files found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- System Information -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> System Information</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Analyzer Status:</strong></td>
                        <td>
                            {% if analyzer_available %}
                            <span class="badge bg-success">Available</span>
                            {% else %}
                            <span class="badge bg-warning">Demo Mode</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Top200 Analyzer:</strong></td>
                        <td>
                            {% if top200_available %}
                            <span class="badge bg-success">Available</span>
                            {% else %}
                            <span class="badge bg-danger">Not Available</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Total Cache Files:</strong></td>
                        <td>{{ total_files or 0 }}</td>
                    </tr>
                    <tr>
                        <td><strong>Cache Mode:</strong></td>
                        <td>
                            {% if analyzer_available %}
                            Live + Cache
                            {% else %}
                            Cache Only
                            {% endif %}
                        </td>
                    </tr>
                    {% if cache_info and cache_info.last_cleanup %}
                    <tr>
                        <td><strong>Last Cleanup:</strong></td>
                        <td>{{ cache_info.last_cleanup }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-cog"></i> Cache Management</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshCache()">
                        <i class="fas fa-sync-alt"></i> Refresh Cache Info
                    </button>
                    
                    <button class="btn btn-outline-warning" onclick="cleanupCache()">
                        <i class="fas fa-broom"></i> Cleanup Old Files
                    </button>
                    
                    <button class="btn btn-outline-info" onclick="exportCacheManifest()">
                        <i class="fas fa-download"></i> Export Manifest
                    </button>
                    
                    <button class="btn btn-outline-danger" onclick="clearCache()">
                        <i class="fas fa-trash"></i> Clear All Cache
                    </button>
                </div>
                
                <hr>
                
                <h6>Quick Stats:</h6>
                <ul class="mb-0">
                    {% if cache_info %}
                    <li>Hit Rate: {{ "%.1f"|format(cache_info.hit_rate or 0) }}%</li>
                    <li>Cache Hits: {{ cache_info.hits or 0 }}</li>
                    <li>Cache Misses: {{ cache_info.misses or 0 }}</li>
                    <li>Total Size: {{ "%.1f"|format(cache_info.cache_size_mb or 0) }} MB</li>
                    {% else %}
                    <li>Cache information not available</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status"></div>
                        <p>Loading file preview...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="loadFileBtn" onclick="loadPreviewedFile()">
                    <i class="fas fa-upload"></i> Load This File
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPreviewFile = null;
    
    function refreshCache() {
        showLoading('Refreshing cache information...', 'Scanning cache directories');
        location.reload();
    }
    
    function cleanupCache() {
        if (!confirm('This will remove old cache files. Continue?')) return;
        
        showLoading('Cleaning up cache...', 'Removing expired files');
        
        // This would call a cleanup endpoint
        fetch('/api/cache/cleanup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showAlert(`Cleanup completed. ${data.removed_files || 0} files removed.`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Cleanup failed: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Cleanup error: ' + error.message, 'danger');
        });
    }
    
    function clearCache() {
        if (!confirm('This will delete ALL cached files. This cannot be undone. Continue?')) return;
        
        showLoading('Clearing cache...', 'Removing all cached files');
        
        fetch('/api/cache/clear', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({confirm: true})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showAlert('Cache cleared successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Clear cache failed: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Clear cache error: ' + error.message, 'danger');
        });
    }
    
    function previewFile(filePath) {
        currentPreviewFile = filePath;
        const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
        
        document.getElementById('filePreviewContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status"></div>
                <p>Loading preview for ${filePath.split('/').pop()}...</p>
            </div>
        `;
        
        modal.show();
        
        // Load file preview (mock implementation)
        setTimeout(() => {
            const fileName = filePath.split('/').pop();
            const fileExt = fileName.split('.').pop().toLowerCase();
            
            let content = '';
            if (fileExt === 'csv') {
                content = `
                    <h6>CSV File: ${fileName}</h6>
                    <div class="alert alert-info">
                        This appears to be a CSV analysis file. 
                        Click "Load This File" to import the analysis data.
                    </div>
                    <p><strong>File:</strong> ${fileName}</p>
                    <p><strong>Type:</strong> Analysis Data (CSV)</p>
                    <p><strong>Path:</strong> <code>${filePath}</code></p>
                `;
            } else if (fileExt === 'json') {
                content = `
                    <h6>JSON File: ${fileName}</h6>
                    <div class="alert alert-info">
                        This appears to be a JSON analysis file.
                        Click "Load This File" to import the analysis data.
                    </div>
                    <p><strong>File:</strong> ${fileName}</p>
                    <p><strong>Type:</strong> Analysis Data (JSON)</p>
                    <p><strong>Path:</strong> <code>${filePath}</code></p>
                `;
            } else {
                content = `
                    <h6>File: ${fileName}</h6>
                    <p><strong>Type:</strong> ${fileExt.toUpperCase()}</p>
                    <p><strong>Path:</strong> <code>${filePath}</code></p>
                    <div class="alert alert-warning">
                        Preview not available for this file type.
                    </div>
                `;
            }
            
            document.getElementById('filePreviewContent').innerHTML = content;
        }, 1000);
    }
    
    function loadPreviewedFile() {
        if (currentPreviewFile) {
            window.location.href = `/load-analysis?file=${encodeURIComponent(currentPreviewFile)}`;
        }
    }
    
    function deleteFile(filePath) {
        const fileName = filePath.split('/').pop();
        if (!confirm(`Delete file "${fileName}"? This cannot be undone.`)) return;
        
        showAlert('File deletion would be implemented here', 'info');
    }
    
    function exportCacheManifest() {
        showAlert('Cache manifest export would be implemented here', 'info');
    }
</script>
{% endblock %}