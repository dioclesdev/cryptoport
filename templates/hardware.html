{% extends "base.html" %}

{% block title %}Hardware Wallet - Crypto Bullrun Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-lock"></i> Hardware Wallet Integration</h1>
            <div>
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <p class="text-muted">Import your cryptocurrency holdings from hardware wallets or manual addresses</p>
    </div>
</div>

<!-- Hardware Wallet Options -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-usb fa-3x text-primary mb-3"></i>
                <h5>Ledger Wallet</h5>
                <p class="text-muted">Connect your Ledger hardware wallet to automatically import balances</p>
                <button class="btn btn-primary" onclick="scanLedger()" id="ledgerBtn">
                    <i class="fas fa-search"></i> Scan Ledger
                </button>
                <small class="text-muted d-block mt-2">Requires Ledger Live Bridge</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                <h5>Trezor Wallet</h5>
                <p class="text-muted">Connect your Trezor hardware wallet to import your holdings</p>
                <button class="btn btn-success" onclick="scanTrezor()" id="trezorBtn">
                    <i class="fas fa-search"></i> Scan Trezor
                </button>
                <small class="text-muted d-block mt-2">Requires Trezor Bridge</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="fas fa-keyboard fa-3x text-warning mb-3"></i>
                <h5>Manual Entry</h5>
                <p class="text-muted">Enter wallet addresses manually to check balances</p>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#manualAddressModal">
                    <i class="fas fa-edit"></i> Enter Addresses
                </button>
                <small class="text-muted d-block mt-2">Works with any wallet</small>
            </div>
        </div>
    </div>
</div>

<!-- Scan Results -->
<div id="scanResults" style="display: none;">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list"></i> Wallet Balances Found</h5>
                    <div>
                        <span id="totalValue" class="badge bg-success me-2">$0.00</span>
                        <button class="btn btn-sm btn-primary" onclick="importToPortfolio()">
                            <i class="fas fa-import"></i> Import to Portfolio
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportResults()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="balanceTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Symbol</th>
                                    <th>Balance</th>
                                    <th>USD Value</th>
                                    <th>Network</th>
                                    <th>Address</th>
                                </tr>
                            </thead>
                            <tbody id="balanceTableBody">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Address Modal -->
<div class="modal fade" id="manualAddressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Manual Address Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualAddressForm">
                    <div class="mb-3">
                        <label for="addressList" class="form-label">Wallet Addresses</label>
                        <textarea class="form-control" id="addressList" rows="8" 
                                  placeholder="Enter wallet addresses, one per line:&#10;&#10;1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa (Bitcoin)&#10;0x742F96B7e9a20A9E4A34F1F3d1CF4d7e7C5dA845 (Ethereum)&#10;DQVQyVNjV4JqJdxLjHXmnFCxvGdZCd4K9G (Dogecoin)"></textarea>
                        <div class="form-text">
                            Supported networks: Bitcoin, Ethereum, Litecoin, Dogecoin, and more.
                            The system will automatically detect the network type.
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Supported Address Formats:</h6>
                        <ul class="mb-0">
                            <li><strong>Bitcoin:</strong> Legacy (1...), SegWit (3...), Bech32 (bc1...)</li>
                            <li><strong>Ethereum:</strong> 0x... (also works for ERC-20 tokens)</li>
                            <li><strong>Litecoin:</strong> L... or M... addresses</li>
                            <li><strong>Dogecoin:</strong> D... addresses</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scanManualAddresses()">
                    <i class="fas fa-search"></i> Check Balances
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Instructions Section -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-question-circle"></i> How to Use Hardware Wallet Integration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-usb"></i> Ledger Wallet</h6>
                        <ol>
                            <li>Install <a href="https://www.ledger.com/ledger-live" target="_blank">Ledger Live</a></li>
                            <li>Connect your Ledger device</li>
                            <li>Open the cryptocurrency apps on your device</li>
                            <li>Click "Scan Ledger" to detect balances</li>
                        </ol>
                        
                        <h6 class="mt-4"><i class="fas fa-shield-alt"></i> Trezor Wallet</h6>
                        <ol>
                            <li>Install <a href="https://suite.trezor.io/" target="_blank">Trezor Suite</a></li>
                            <li>Connect your Trezor device</li>
                            <li>Unlock your device with PIN</li>
                            <li>Click "Scan Trezor" to detect balances</li>
                        </ol>
                    </div>
                    
                    <div class="col-md-6">
                        <h6><i class="fas fa-keyboard"></i> Manual Entry</h6>
                        <ol>
                            <li>Copy wallet addresses from your wallet app</li>
                            <li>Paste them into the manual entry form</li>
                            <li>One address per line</li>
                            <li>System automatically detects network type</li>
                        </ol>
                        
                        <div class="alert alert-warning mt-3">
                            <h6><i class="fas fa-exclamation-triangle"></i> Privacy Notice</h6>
                            <p class="mb-0">Address balances are checked using public blockchain APIs. 
                            No private keys are transmitted or stored. Your addresses are only used 
                            to fetch public balance information.</p>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-12">
                        <h6><i class="fas fa-chart-line"></i> After Import</h6>
                        <p>Once imported to your portfolio:</p>
                        <ul>
                            <li>Balances will be analyzed for bullrun potential</li>
                            <li>Current USD values will be calculated</li>
                            <li>Performance tracking will be available</li>
                            <li>Automatic updates on portfolio refresh</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Section -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> System Status</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Hardware Support:</strong><br>
                        <span id="hardwareStatus" class="badge bg-warning">Checking...</span>
                    </div>
                    <div class="col-md-3">
                        <strong>API Status:</strong><br>
                        <span id="apiStatus" class="badge bg-success">Online</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Networks:</strong><br>
                        <span class="badge bg-info">BTC, ETH, LTC, DOGE</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Last Scan:</strong><br>
                        <span id="lastScan">Never</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let scanResultsData = [];
    
    // Check hardware wallet support on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkHardwareSupport();
    });
    
    function checkHardwareSupport() {
        // This would check if hardware wallet bridges are available
        document.getElementById('hardwareStatus').innerHTML = '<span class="badge bg-warning">Limited</span>';
        document.getElementById('hardwareStatus').title = 'Hardware wallet integration requires additional software';
    }
    
    function scanLedger() {
        const btn = document.getElementById('ledgerBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
        
        showLoading('Scanning Ledger Wallet...', 'Please confirm on your device if prompted');
        
        fetch('/api/hardware-scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({wallet_type: 'ledger'})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Scan Ledger';
            
            if (data.success) {
                displayScanResults(data.results, data.total_value);
                document.getElementById('lastScan').textContent = new Date().toLocaleString();
            } else {
                showAlert('Ledger scan failed: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Scan Ledger';
            showAlert('Hardware wallet not available: ' + error.message, 'warning');
        });
    }
    
    function scanTrezor() {
        const btn = document.getElementById('trezorBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
        
        showLoading('Scanning Trezor Wallet...', 'Please confirm on your device if prompted');
        
        fetch('/api/hardware-scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({wallet_type: 'trezor'})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Scan Trezor';
            
            if (data.success) {
                displayScanResults(data.results, data.total_value);
                document.getElementById('lastScan').textContent = new Date().toLocaleString();
            } else {
                showAlert('Trezor scan failed: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Scan Trezor';
            showAlert('Hardware wallet not available: ' + error.message, 'warning');
        });
    }
    
    function scanManualAddresses() {
        const addresses = document.getElementById('addressList').value.trim();
        if (!addresses) {
            showAlert('Please enter at least one address', 'warning');
            return;
        }
        
        const addressList = addresses.split('\n').map(addr => addr.trim()).filter(addr => addr);
        
        showLoading('Checking Address Balances...', 'This may take a moment for multiple addresses');
        
        fetch('/api/hardware-scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                wallet_type: 'manual',
                addresses: addressList
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                displayScanResults(data.results, data.total_value);
                bootstrap.Modal.getInstance(document.getElementById('manualAddressModal')).hide();
                document.getElementById('addressList').value = '';
                document.getElementById('lastScan').textContent = new Date().toLocaleString();
            } else {
                showAlert('Address scan failed: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Address scan error: ' + error.message, 'danger');
        });
    }
    
    function displayScanResults(results, totalValue) {
        scanResultsData = results;
        
        const tbody = document.getElementById('balanceTableBody');
        tbody.innerHTML = '';
        
        document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(2);
        
        results.forEach((balance, index) => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="checkbox" class="balance-checkbox" value="${index}" checked></td>
                <td><strong>${balance.symbol}</strong></td>
                <td>${balance.balance.toFixed(8)}</td>
                <td>$${(balance.usd_value || 0).toFixed(2)}</td>
                <td>${balance.network}</td>
                <td><small class="text-muted">${truncateAddress(balance.address)}</small></td>
            `;
        });
        
        document.getElementById('scanResults').style.display = 'block';
        document.getElementById('scanResults').scrollIntoView({behavior: 'smooth'});
    }
    
    function truncateAddress(address) {
        if (!address || address.length <= 16) return address;
        return address.substring(0, 8) + '...' + address.substring(address.length - 8);
    }
    
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.balance-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }
    
    function importToPortfolio() {
        const checkboxes = document.querySelectorAll('.balance-checkbox:checked');
        if (checkboxes.length === 0) {
            showAlert('Please select at least one balance to import', 'warning');
            return;
        }
        
        const selectedBalances = [];
        checkboxes.forEach(checkbox => {
            const index = parseInt(checkbox.value);
            selectedBalances.push(scanResultsData[index]);
        });
        
        showLoading('Importing to Portfolio...', 'Adding selected balances to your portfolio');
        
        fetch('/api/hardware-import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({balances: selectedBalances})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/portfolio';
                }, 2000);
            } else {
                showAlert('Import failed: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('Import error: ' + error.message, 'danger');
        });
    }
    
    function exportResults() {
        if (scanResultsData.length === 0) {
            showAlert('No results to export', 'warning');
            return;
        }
        
        const csv = generateCSV(scanResultsData);
        downloadCSV(csv, 'hardware_wallet_balances.csv');
    }
    
    function generateCSV(data) {
        const headers = ['Symbol', 'Balance', 'USD_Value', 'Network', 'Address'];
        const rows = data.map(balance => [
            balance.symbol,
            balance.balance,
            balance.usd_value || 0,
            balance.network,
            balance.address
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }
    
    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}